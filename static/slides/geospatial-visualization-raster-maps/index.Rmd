---
title: "Geospatial visualization: raster maps"
author: "[MACS 30500](https://cfss.uchicago.edu) <br /> University of Chicago"
output: rcfss::xaringan
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(
  cache = TRUE,
  message = FALSE,
  warning = FALSE,
  echo = FALSE,
  fig.retina = 2, fig.width = 12
)

library(tidyverse)
library(sf)
library(ggmap)
library(tidycensus)
library(RColorBrewer)
library(patchwork)
library(here)

# easier to generate tidycensus maps
if (!identical(getOption("bitmapType"), "cairo") && isTRUE(capabilities()[["cairo"]])){
  options(bitmapType = "cairo")
}

set.seed(1234)
theme_set(theme_minimal(base_size = rcfss::base_size))
```

# Geospatial visualizations

* Earliest form of information visualizations
* Geospatial data visualizations
* [Google Maps](https://www.google.com/maps)

---

# Dr. John Snow

.center[

[![:scale 70%](https://upload.wikimedia.org/wikipedia/commons/2/27/Snow-cholera-map-1.jpg)](https://commons.wikimedia.org/wiki/File:Snow-cholera-map-1.jpg)

]

---

# Minard's map of Napoleon's march on Russia

[![Charles Minard's 1869 chart showing the number of men in Napoleonâ€™s 1812 Russian campaign army, their movements, as well as the temperature they encountered on the return path. Source: Wikipedia.](https://upload.wikimedia.org/wikipedia/commons/2/29/Minard.png)](https://en.wikipedia.org/wiki/File:Minard.png)

---

# Minard's map of Napoleon's march on Russia

[![English translation of Minard's map](https://upload.wikimedia.org/wikipedia/commons/thumb/e/e2/Minard_Update.png/1280px-Minard_Update.png)](https://commons.wikimedia.org/wiki/File:Minard_Update.png)

---

# Designing modern maps

* Depict spatial features
* Incorporate additional attributes and information
* Major features
    * Scale
    * Projection
    * Symbols

---

# Scale

* Proportion between distances and sizes on a map and their actual distances and sizes on Earth
* Small-scale map
* Large-scale map


---

# Large-scale map

```{r large-scale}
# establish bounding box, get map, and plot
c(
  left = -128.364258,
  bottom = 11.480025,
  right = -65.742188,
  top = 55.329144
) %>%
  get_stamenmap(zoom = 5) %>%
  ggmap()
```

---

# Small-scale map

```{r small-scale}
# establish bounding box, get map, and plot
c(
  left = -87.612448,
  bottom = 41.783393,
  right = -87.581871,
  top = 41.803470
) %>%
  get_stamenmap(zoom = 15) %>%
  ggmap()
```

---

# Projection

* Process of taking a three-dimensional object and visualizing it on a two-dimensional surface
* No 100% perfect method for this
* Always introduces distortions
* Properties of projection methods
    1. Shape
    1. Area
    1. Angles
    1. Distance
    1. Direction

---

# Conformal projections

```{r import-world, include = FALSE}
world <- here("static/data/nautral_earth/ne_110m_admin_0_countries/ne_110m_admin_0_countries.shp") %>%
  st_read()
```

```{r mercator, dependson = "import-world"}
world %>%
  st_transform("+proj=merc") %>%
  ggplot() +
  geom_sf() +
  ggtitle("Mercator projection")
```

---

# Equal-area projections

```{r equal-area, dependson = "import-world"}
{
  world %>%
    st_transform("+proj=laea") %>%
    ggplot() +
    geom_sf() +
    ggtitle("Lambert equal area projection")
} + {
  world %>%
    st_transform("+proj=cea") %>%
    ggplot() +
    geom_sf() +
    ggtitle("Equal area cylindrical projection")
}
```

---

# Mollweide

```{r mollweide, dependson = "import-world"}
world %>%
  st_transform("+proj=moll") %>%
  ggplot() +
  geom_sf() +
  ggtitle("Mollweide projection")
```

---

# Symbols

```{r bb-hydepark-stamen}
# store bounding box coordinates
hydepark_bb <- c(
  left = -87.612448,
  bottom = 41.783393,
  right = -87.581871,
  top = 41.803470
)

hydepark_stamen <- get_stamenmap(
  bbox = hydepark_bb,
  zoom = 16
)
ggmap(hydepark_stamen)
```

---

# `ggmap`

* Package for drawing maps using `ggplot2` and **raster** map tiles
* Static image files generated by mapping services
* Focus on incorporating data into existing maps
* Severely limits ability to change the appearance of the geographic map

---

# Obtain map images

* [OpenStreetMap](https://www.openstreetmap.org/)
* [Stamen Maps](http://maps.stamen.com/#terrain/12/37.7706/-122.3782)
* [Google Maps](https://maps.google.com)

--

## Method for specifying map regions

1. Bounding box
1. Center/zoom

---

# Bounding box

```{r bb-chicago-stamen, echo = TRUE}
# store bounding box coordinates
chi_bb <- c(
  left = -87.936287,
  bottom = 41.679835,
  right = -87.447052,
  top = 42.000835
)

chicago_stamen <- get_stamenmap(
  bbox = chi_bb,
  zoom = 11
)
chicago_stamen
```

---

# Bounding box

```{r bb-chicago-stamen-plot, echo = TRUE}
ggmap(chicago_stamen)
```

---

# Level of detail

```{r bb-chicago-stamen-zoom}
{
  get_stamenmap(
    bbox = chi_bb,
    zoom = 12
  ) %>%
    ggmap() +
    ggtitle("Zoom = 12")
} + {
  get_stamenmap(
    bbox = chi_bb,
    zoom = 10
  ) %>%
    ggmap() +
    ggtitle("Zoom = 10")
}
```

---

# Identifying bounding box

> Use [bboxfinder.com](http://bboxfinder.com/#0.000000,0.000000,0.000000,0.000000) to determine the exact longitude/latitude coordinates for the bounding box you wish to obtain.

---

# Types of map tiles

```{r stamen-maptype, echo = FALSE}
stamen_maptype <- tibble(maptype = c(
  "terrain", "terrain-background",
  "terrain-lines",
  "toner", "toner-2010", "toner-2011",
  "toner-background", "toner-hybrid",
  "toner-labels", "toner-lines",
  "toner-lite", "watercolor"
)) %>%
  mutate(
    bb = map(maptype, ~ get_stamenmap(bbox = chi_bb, zoom = 10, maptype = .x)),
    ggmap = map2(bb, maptype, ~ ggmap(.x) +
      ggtitle(.y) +
      theme_minimal(base_size = rcfss::base_size * 0.4))
  )

wrap_plots(stamen_maptype$ggmap)
```

---

# Import crime data

* City of Chicago open data portal
* [Crime data from 2017](https://data.cityofchicago.org/Public-Safety/Crimes-2017/d62x-nvdr)

```{r import-crimes}
crimes <- here("static", "data", "Crimes_-_2017.csv") %>%
  read_csv()
glimpse(crimes)
```

---

# Plot high-level map of crime

```{r import-chicago}
chicago <- chicago_stamen
ggmap(chicago)
```

---

# Using `geom_point()`

```{r plot-crime-point, dependson = "import-crimes", echo = TRUE, fig.height = 6}
ggmap(chicago) +
  geom_point(
    data = crimes,
    mapping = aes(
      x = Longitude,
      y = Latitude
    )
  )
```

---

# Using `geom_point()`

```{r plot-crime-point-alpha, dependson = "import-crimes", echo = TRUE, fig.height = 6}
ggmap(chicago) +
  geom_point(
    data = crimes,
    aes(
      x = Longitude,
      y = Latitude
    ),
    size = .25,
    alpha = .01
  )
```

---

# Using `stat_density_2d()`

```{r kde-contour, dependson = "import-crimes", echo = TRUE, fig.height = 6}
ggmap(chicago) +
  geom_density_2d(
    data = crimes,
    aes(
      x = Longitude,
      y = Latitude
    )
  )
```

---

# Using `stat_density_2d()`

```{r kde-fill, dependson = "import-crimes", echo = TRUE, fig.height = 6}
ggmap(chicago) +
  stat_density_2d(
    data = crimes,
    aes(
      x = Longitude,
      y = Latitude,
      fill = stat(level)
    ),
    geom = "polygon"
  )
```

---

# Using `stat_density_2d()`

```{r plot-crime-density, dependson = "import-crimes"}
ggmap(chicago) +
  stat_density_2d(
    data = crimes,
    aes(
      x = Longitude,
      y = Latitude,
      fill = stat(level)
    ),
    alpha = .2,
    bins = 25,
    geom = "polygon"
  ) +
  scale_fill_gradientn(colors = brewer.pal(7, "YlOrRd"))
```

---

# Looking for variation

```{r plot-crime-wday, dependson = "import-crimes"}
ggmap(chicago) +
  stat_density_2d(
    data = crimes %>%
      filter(`Primary Type` %in% c(
        "BURGLARY", "MOTOR VEHICLE THEFT",
        "NARCOTICS", "ROBBERY"
      )),
    aes(
      x = Longitude,
      y = Latitude,
      fill = stat(level)
    ),
    alpha = .4,
    bins = 10,
    geom = "polygon"
  ) +
  scale_fill_gradientn(colors = brewer.pal(7, "YlOrRd")) +
  facet_wrap(~`Primary Type`)
```

---

# Locations of murders

```{r homicide, dependson = "import-crimes"}
(homicides <- crimes %>%
  filter(`Primary Type` == "HOMICIDE"))
```

---

# Locations of murders

```{r homicide-city, dependson = "homicide"}
ggmap(chicago) +
  geom_point(
    data = homicides,
    mapping = aes(
      x = Longitude,
      y = Latitude
    ),
    size = 1
  )
```

---

# Locations of murders

```{r get-community-areas, include = FALSE}
library(sf)

# import shapefile with area names and numbers
areas <- here(
  "static", "data", "Boundaries - Community Areas (current)",
  "geo_export_328cdcbf-33ba-4997-8ce8-90953c6fec19.shp"
) %>%
  st_read()

crimes %>%
  filter(`Primary Type` == "HOMICIDE") %>%
  count(`Community Area`, sort = TRUE) %>%
  left_join(areas %>%
    select(community, area_numbe) %>%
    mutate(area_numbe = as.numeric(as.character(area_numbe))),
  by = c("Community Area" = "area_numbe")
  )
```

```{r get-high-low-murder-maps}
# North Lawndale is the highest homicides in 2017
# Compare to Kenwood
north_lawndale_bb <- c(
  left = -87.749047,
  bottom = 41.840185,
  right = -87.687893,
  top = 41.879850
)
north_lawndale <- get_stamenmap(
  bbox = north_lawndale_bb,
  zoom = 14
)

kenwood_bb <- c(
  left = -87.613113,
  bottom = 41.799215,
  right = -87.582536,
  top = 41.819064
)
kenwood <- get_stamenmap(
  bbox = kenwood_bb,
  zoom = 15
)

{
  ggmap(north_lawndale) +
    ggtitle("North Lawndale")
} + {
  ggmap(kenwood) +
    ggtitle("Kenwood")
}
```

---

# Locations of murders

```{r plot-murder, dependson = "homicide"}
{
  ggmap(north_lawndale) +
    geom_point(
      data = homicides,
      aes(x = Longitude, y = Latitude)
    ) +
    ggtitle("North Lawndale")
} + {
  ggmap(kenwood) +
    geom_point(
      data = homicides,
      aes(x = Longitude, y = Latitude)
    ) +
    ggtitle("Kenwood")
}
```

---

# Additional aesthetics

```{r violent, dependson = "import-crimes"}
violent <- crimes %>%
  filter(`Primary Type` %in% c(
    "HOMICIDE",
    "CRIM SEXUAL ASSAULT",
    "ROBBERY"
  ))
```

```{r plot-violent, dependson = "violent"}
{
  ggmap(north_lawndale) +
    geom_point(
      data = violent,
      aes(
        x = Longitude, y = Latitude,
        color = `Primary Type`
      )
    ) +
    scale_color_brewer(type = "qual", palette = "Dark2", guide = guide_legend(nrow = 3)) +
    theme(legend.position = "bottom") +
    labs(
      title = "North Lawndale",
      color = NULL
    )
} + {
  ggmap(kenwood) +
    geom_point(
      data = violent,
      aes(
        x = Longitude, y = Latitude,
        color = `Primary Type`
      )
    ) +
    scale_color_brewer(type = "qual", palette = "Dark2", guide = guide_legend(nrow = 3)) +
    theme(legend.position = "bottom") +
    labs(
      title = "Kenwood",
      color = NULL
    )
}
```


---

# Exercise using `ggmap`

![](https://pixel.nymag.com/imgs/daily/strategist/2018/09/05/schwinn-recumbent-exercise-bike.w710.h473.2x.jpg)


