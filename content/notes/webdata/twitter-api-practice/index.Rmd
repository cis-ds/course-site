---
title: "Practice getting data from the Twitter API"
date: 2019-03-01

type: book
toc: true
draft: false
aliases: ["/webdata002_twitter_exercise.html", "/notes/twitter-api-practice/"]
categories: ["webdata"]

weight: 62
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(cache = TRUE)
```

```{r packages, cache = FALSE, message = FALSE}
library(tidyverse)
library(rtweet)

set.seed(1234)
theme_set(theme_minimal())
```

{{% callout note %}}

Run the code below in your console to download this exercise as a set of R scripts.

```r
usethis::use_course("cis-ds/getting-data-from-the-web-api-access")
```

{{% /callout %}}

There are several packages for R for accessing and searching Twitter. Twitter actually has two separate APIs:

1. The **REST** API - this allows you programmatic access to read and write Twitter data. For research purposes, this allows you to search the recent history of tweets and look up specific users.
1. The **Streaming** API - this allows you to access the public data flowing through Twitter in real-time. It requires your R session to be running continuously, but allows you to capture a much larger sample of tweets while avoiding rate limits for the REST API.

## Using `rtweet`

Here, we are going to practice using the [`rtweet`](https://docs.ropensci.org/rtweet/) package to search Twitter.

```{r twitter, cache = FALSE}
library(rtweet)
```

```{r rtweet-auth, include = FALSE, cache = FALSE}
# retrieve stored bearer token
auth_as("cfss")
```

## OAuth authentication

All you need is a **Twitter account** (user name and password) and you can be up in running in minutes!

Simply send a request to Twitter's API (with a function like `search_tweets()`, `get_timeline()`, `get_followers()`, `get_favorites()`, etc.) during an interactive session of R, authorize the embedded **`rstats2twitter`** app (approve the browser popup), and your token will be created and saved/stored (for future sessions) for you!

{{% callout warning %}}

Students using [RStudio Workbench](/setup/r-server/) will not be able to follow this authentication process since you cannot run an interactive session of R that connects to your web browser. Instead, I will provide you with a script during class that you can run to create your token.

{{% /callout %}}

## Searching tweets

To find 3000 recent tweets using the "rstats" hashtag:

```{r twitter-rstats}
rt <- search_tweets(
  q = "#rstats",
  n = 3000,
  include_rts = FALSE
)
rt
```

* `q` - the search query
* `n` - maximum number of tweets to be returned
* `include_rts = FALSE` - exclude retweets generated by Twitter's built-in "retweet" function. We only want original tweets.

The resulting object is a `tibble` data frame with one row for each tweet. The data frame contains the full text of the tweet (`text`), the username of the poster (`screen_name`), as well as a wealth of metadata.

Note that the Twitter REST API limits all searches to the past 6-9 days. **You will not retrieve any earlier results.**

## Searching users

Use `get_timeline()` to retrieve tweets from one or more specified Twitter users. This only works for users with public profiles or those that have authorized your app.

```{r twitter-count}
countvoncount <- get_timeline(user = "countvoncount", n = 4000)
countvoncount
```

With `get_timeline()`, you are not limited to only the most recent 6-9 days of tweets.

## Visualizing tweets

Because the resulting objects are data frames, you can perform standard data transformation, summarization, and visualization on the underlying data.

`rtweet` includes the `ts_plot()` function which automates some common time series visualization methods. For example, we can quickly visualize the frequency of `@countvoncount` tweets:

```{r countvoncount-freq}
ts_plot(countvoncount, by = "1 week")
```

The `by` argument allows us to aggregate over different lengths of time.

```{r countvoncount-freq-month}
ts_plot(countvoncount, by = "1 month")
```

And because `ts_plot()` uses `ggplot2`, we can modify the graphs using familiar `ggplot2` functions:

```{r countvoncount-freq-clean}
ts_plot(countvoncount, by = "1 week") +
  theme(plot.title = element_text(face = "bold")) +
  labs(
    x = NULL, y = NULL,
    title = "Frequency of @countvoncount Twitter posts",
    subtitle = "Twitter status (tweet) counts aggregated using one week intervals",
    caption = "\nSource: Data collected from Twitter's REST API via rtweet"
  )
```

## Exercise: Practice using `rtweet`

1. Find the 1000 most recent tweets by [Katy Perry](https://twitter.com/katyperry), [Kim Kardashian](https://twitter.com/KimKardashian), and [Rihanna](https://twitter.com/Rihanna).
1. Visualize their tweet frequency by week. Who posts most often? Who posts least often?

    {{< spoiler text="Click for the solution" >}}

```{r twitter-popstars}
katy_perry <- get_timeline(
  user = "katyperry",
  n = 1000
)

kim_kardashian <- get_timeline(
  user = "KimKardashian",
  n = 1000
)

rihanna <- get_timeline(
  user = "rihanna",
  n = 1000
)

# combine, group by character, and plot weekly tweet frequency
bind_rows(
  `Katy Perry` = katy_perry %>% select(created_at),
  `Kim Kardashian` = kim_kardashian %>% select(created_at),
  `Rihanna` = rihanna %>% select(created_at),
  .id = "screen_name"
) %>%
  group_by(screen_name) %>%
  ts_plot(by = "months")
```

    {{< /spoiler >}}

## Acknowledgments

```{r child = here::here("R", "_ack_stat545.Rmd")}
```
* OAuth token storage derived from ["Obtaining and using access tokens"](http://rtweet.info/articles/auth.html).

## Session Info

```{r child = here::here("R", "_session-info.Rmd")}
```
